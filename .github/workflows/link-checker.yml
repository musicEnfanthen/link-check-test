name: Link Checker

on:
  schedule:
    - cron: 0 13 * * 0  # run every Monday at 1pm UTC https://crontab.guru/#0_13_*_*_1 
  workflow_dispatch: # trigger manually
  
jobs:
  website_link_check:
    name: Check website links
    runs-on: ubuntu-latest
    
    steps:
      - name: Broken Link Check MEI
        uses: technote-space/broken-link-checker-action@v2
        with:
          target: https://music-encoding.org
      
      
  markdown-link-check:
    name: Check markdown links
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
      
    - uses: actions/checkout@v2
      with:
        repository: musicEnfanthen/music-encoding.github.io
        ref: master
        path: check-dir
      
    - name: Check file path
      run: |
        ls -alh  
    
    - uses: gaurav-nelson/github-action-markdown-link-check@1.0.8
      id: mlc
      with:
        folder-path: check-dir
        config-file: .github/link-check-config.json
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
    
    - name: Dump GitHub context
      if: always()
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"
    - name: Dump job context
      if: always()
      env:
        JOB_CONTEXT: ${{ toJson(job) }}
      run: echo "$JOB_CONTEXT"
    - name: Dump steps context
      if: always()
      env:
        STEPS_CONTEXT: ${{ toJson(steps) }}
      run: echo "$STEPS_CONTEXT"
    - name: Dump runner context
      if: always()
      env:
        RUNNER_CONTEXT: ${{ toJson(runner) }}
      run: echo "$RUNNER_CONTEXT"
    - name: Dump strategy context
      if: always()
      env:
        STRATEGY_CONTEXT: ${{ toJson(strategy) }}
      run: echo "$STRATEGY_CONTEXT"
    - name: Dump matrix context
      if: always()
      env:
         MATRIX_CONTEXT: ${{ toJson(matrix) }}
      run: echo "$MATRIX_CONTEXT"
    
    - name: Create issue for broken links
      if: failure()
      id: create-issue
      uses: JasonEtco/create-an-issue@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RUN_ID: ${{ github.run_id }}
        RUN_NUMBER: ${{ github.run_number }}
        ACTION_PATH: ${{ github.action_path }}
        EVENT_PATH: ${{ github.event_path }}
        JOB: ${{ github.job }}
      with:
        filename: .github/link-check-issue-template.md
    - name: Link to issue
      if: failure()
      run: 'echo Created ${{ steps.create-issue.outputs.url }}'
